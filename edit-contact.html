<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="styles.css">

    <script>

        var contactKey;

        function init() {
            webApp = window.Telegram.WebApp;
            if (webApp != null) {
                webApp.expand();
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                contactKey = urlParams.get('key');
                if (contactKey) {
                    getContact();
                }
            }
        }

        function getContact() {
            log("Get stored key: " + contactKey);
            var request = webApp.CloudStorage.getItem(contactKey, onStoredKey);
        }

        function onStoredKey(error, value) {
            if (!error) {
                if (value.length == 0) {
                    log("no key found");
                } else {
                    fillData(value);
                    //createContactListItem(value);
                }
            } else {
                log(error);
            }
        }

        function fillData(value) {
            var item = JSON.parse(value);
            document.getElementById("displayName").value = item.displayName;
            document.getElementById("shortRemark").value = item.shortRemark;
            document.getElementById("firstName").value = item.firstName;
            document.getElementById("lastName").value = item.lastName;
            document.getElementById("gender").value = item.gender;
            document.getElementById("dateOfBirth").value = item.dateOfBirth;
            document.getElementById("placeOfBirth").value = item.placeOfBirth;
            document.getElementById("nationality").value = item.nationality;
            document.getElementById("occupation").value = item.occupation;
            document.getElementById("company").value = item.company;
            document.getElementById("workStatus").value = item.workStatus;
            document.getElementById("description").value = item.description;
        }

        function viewContact() {
            showViewContactScreen(contactKey);
        }

        function updateContact() {
            var newValue = {
                displayName: document.getElementById("displayName").value,
                shortRemark: document.getElementById("shortRemark").value,
                firstName: document.getElementById("firstName").value,
                lastName: document.getElementById("lastName").value,
                gender: document.getElementById("gender").value,
                dateOfBirth: document.getElementById("dateOfBirth").value,
                placeOfBirth: document.getElementById("placeOfBirth").value,
                nationality: document.getElementById("nationality").value,
                occupation: document.getElementById("occupation").value,
                company: document.getElementById("company").value,
                workStatus: document.getElementById("workStatus").value,
                description: document.getElementById("description").value,
                userpic: getUserpicFileString()
            };
            webApp.CloudStorage.setItem(contactKey, JSON.stringify(newValue), showContactsListScreen());
        }

        function deleteContact() {
            let text = "Are you sure you want to delete?";
            if (confirm(text) == true) {
                webApp.CloudStorage.removeItem(contactKey, showContactsListScreen());
            }
        }

        function onUserpicSelected() {
            //alert("userpic file selected");
            alert("onUserpicSelected: " + getUserpicFileString());
        }

        function getUserpicFileString() {
            var userpicInput = document.getElementById("userpic");
            const file = userpicInput.files[0];
            const fileString = getBase64(file);
            return(fileString);
        }

        function getBase64(file) {
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function () {
                var result = reader.result;
                //alert(result);
                return result;
            };
            reader.onerror = function (error) {
                //alert('Error: ' + error);
                return "";
            };
        }


        function readFileIntoMemory(file, callback) {
            var reader = new FileReader();
            reader.onload = function() {
                callback({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    content: new Uint8Array(this.result)
                });
            }
        }

      //
  </script>
    
  </head>
  <body onload="init()">

    <div id="header" class="horizontal-block">
      <button class="back-button">←</button>
      <div class="title-label">Edit Contact</div>
      <button class="menu-button">≡</button>
    </div>

    <div id="newContactScreen" class="newContactScreen switchableDiv">
      <div class="Frame18" style="width: 100%; padding-top: 8px; padding-bottom: 8px; background: white; border-radius: 8px; flex-direction: column; justify-content: flex-start; align-items: flex-start; display: inline-flex">
        <div class="DisplaySettings horizontal-container">
          <div class="userpicBlock" style="width:30%; justify-content: flex-start; align-items: flex-start; display: flex">
            <div class="userpicDiv" style="width: 48px; height: 48px; background: #D9D9D9; border-radius: 4px"></div>
            <div class="userpicControl" style="flex-direction: column; justify-content: center; align-items: flex-start; gap: 4px; display: inline-flex">
              <div class="label">Userpic:</div>
              <input type="file" id="userpic" name="userpic" accept="image/jpeg" style="width: 100%;" onchange="onUserpicSelected()" />
            </div>
          </div>
          <div class="displayNameBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Display name: </div>
            <input type="text" id="displayName" name="displayName" style="width: 100%;" placeholder="Enter display name...">
          </div>
          <div class="shortRemarkBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Short remark: </div>
            <input type="text" id="shortRemark" name="shortRemark" style="width: 100%;" placeholder="Enter short remark...">
          </div>
        </div>
        <div class="BasicPersonalData horizontal-container">
          <div class="firstNameBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">First name: </div>
            <input type="text" id="firstName" name="firstName" style="width: 100%;" placeholder="Enter first name...">
          </div>
          <div class="lastNameBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Last name: </div>
            <input type="text" id="lastName" name="lastName" style="width: 100%;" placeholder="Enter last name...">
          </div>
          <div class="sexBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Sex: </div>
            <select name="gender" id="gender" style="width: 100%;">
              <option value="0">Select</option>
              <option value="m">Male</option>
              <option value="f">Female</option>
              <option value="x">Other</option>
            </select>
          </div>
        </div>
        <div class="BirthData horizontal-container">
          <div class="dateOfBirthBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Date of birth:</div>
            <input type="date" id="dateOfBirth" name="dateOfBirth" style="width: 100%;" placeholder="dd-mm-yyyy">
          </div>
          <div class="placeOfBirthBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Place of birth:</div>
            <select name="placeOfBirth" id="placeOfBirth" style="width: 100%;">
              <option value="0">Select</option>
              <option value="ru">Russia</option>
              <option value="th">Thailand</option>
              <option value="us">USA</option>
              <option value="ua">Ukraine</option>
            </select>
          </div>
          <div class="nationalityBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Nationality:</div>
            <select name="nationality" id="nationality" style="width: 100%;">
              <option value="0">Select</option>
              <option value="ru">Russian</option>
              <option value="th">Thai</option>
              <option value="us">US</option>
              <option value="ua">Ukrainian</option>
            </select>
          </div>
        </div>
        <div class="OccupationData horizontal-container">
          <div class="occupationBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Occupation:</div>
            <input type="text" id="occupation" name="occupation" style="width: 100%;" placeholder="Enter occupation...">
          </div>
          <div class="companyBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Company:</div>
            <input type="text" id="company" name="company" style="width: 100%;" placeholder="Enter company name...">
          </div>
          <div class="statusBlock" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Status:</div>
            <select name="workStatus" id="workStatus" style="width: 100%;">
              <option>Select</option>
              <option value="0">Unknown</option>
              <option value="1">Active</option>
              <option value="2">Vacation</option>
              <option value="3">Sick leave</option>
            </select>
          </div>
        </div>
        <div class="Description horizontal-container">
          <div class="descriptionBlock" style="width: 95%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <div class="label">Description:</div>
            <input type="text" id="description" name="description" style="width: 100%;" placeholder="Enter any text there...">
          </div>
        </div>
        <div class="Frame2 horizontal-container">
          <div class="block1" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <button style="width: 100%;" onclick="viewContact()">Cancel</button>
          </div>
          <div class="block2" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <button style="width: 100%;" onclick="updateContact()">Save</button>
          </div>
          <div class="block3" style="width: 30%; flex-direction: column; justify-content: center; align-items: flex-start; display: inline-flex">
            <button style="width: 100%;" onclick="deleteContact()">Delete</button>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
